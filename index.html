<script>
// Asegúrate de que esta URL sea la de tu implementación de Google Apps Script actualizada
const apiUrl = 'https://script.google.com/macros/s/AKfycbxOW1CWs8n04Lek1Sm0mYZE_F6N0epkbvr0czCt_QzY7qdn65X3g1oya0Br2BtwXQBS/exec';

let allQuestions = [], exam = [], idx = 0, answers = [], correct = [], curUser = null;

// Función de limpieza de texto para comparaciones seguras
const cleanText = (str) => str ? str.toString().toLowerCase().trim().replace(/\s+/g, '') : "";

function doLogin() {
    const emailInput = cleanText(document.getElementById('inEmail').value);
    if(!emailInput) {
        alert("Por favor, introduce tu correo.");
        return;
    }
    
    showScreen('secLoading');
    
    fetchJSONP(apiUrl + '?type=users', function(res) {
        if (!res || !res.rows) {
            alert("Error: No se pudo conectar con la base de datos de usuarios.");
            showScreen('secLogin');
            return;
        }

        const users = parseTable(res.headers, res.rows);
        
        // CORRECCIÓN: Buscamos al usuario limpiando ambos lados de la comparación
        const user = users.find(u => cleanText(u.correo) === emailInput);

        if(user) {
            curUser = user;
            fetchJSONP(apiUrl + '?type=questions', function(qRes) {
                if (!qRes || !qRes.rows) {
                    alert("Error al cargar las preguntas.");
                    showScreen('secLogin');
                    return;
                }
                allQuestions = parseTable(qRes.headers, qRes.rows);
                setupConfig();
                showScreen('secConfig');
            });
        } else {
            alert("Acceso denegado: El correo '" + document.getElementById('inEmail').value + "' no está en la lista de autorizados.");
            showScreen('secLogin');
        }
    });
}

// ... resto de funciones (parseTable, fetchJSONP, etc.) deben mantenerse igual ...
</script>
