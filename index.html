<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ENFOCADOS</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ESTILOS ORIGINALES DE TU ARCHIVO LOCAL */
*{margin:0;padding:0;box-sizing:border-box}
:root{--Y:rgb(250,250,0);--Yd:rgb(215,215,0);--D:#2c3e50;--D2:#1a252f;--V:#10b981;--R:#ef4444;--G:#64748b;--B:#e2e8f0}
body{font-family:'Inter',sans-serif;background:linear-gradient(160deg,#fffef0 0%,#fff9c4 100%);min-height:100vh;color:#1e293b;line-height:1.6}
.wrap{max-width:860px;margin:0 auto;padding:1.8rem 1.2rem}
header{text-align:center;margin-bottom:1.6rem}
h1{font-family:'Montserrat',sans-serif;font-size:3rem;font-weight:800;color:var(--D);letter-spacing:-1px}
.card{background:#fff;border-radius:18px;padding:2rem;box-shadow:0 4px 24px rgba(0,0,0,.08);border:2px solid var(--B);position:relative;margin-bottom:1.5rem}
#loginSection{max-width:400px;margin:2rem auto;text-align:center}
input{width:100%;padding:1rem;margin:1rem 0;border-radius:12px;border:2px solid var(--B);font-size:1rem;outline:none}
.btn-login{width:100%;background:var(--D);color:#fff;padding:1rem;border-radius:12px;border:none;font-weight:700;cursor:pointer;font-family:'Montserrat'}
.p-wrap{margin-bottom:2rem}
.p-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
#qNum{font-family:'Montserrat',sans-serif;font-weight:700;color:var(--D)}
#qProg{font-weight:600;color:var(--G);font-size:.9rem;background:var(--B);padding:.2rem .8rem;border-radius:20px}
.p-bar-bg{height:8px;background:var(--B);border-radius:4px;overflow:hidden}
#pbar{height:100%;width:0%;background:linear-gradient(90deg, var(--Yd), var(--Y));transition:width .4s ease}
.qtxt{font-size:1.35rem;font-weight:600;color:var(--D);margin-bottom:2rem}
.opts{display:grid;gap:1rem}
.opt{display:flex;align-items:center;padding:1.2rem;border:2px solid var(--B);border-radius:16px;cursor:pointer;transition:all .2s ease;background:#f8fafc}
.opt.ok{border-color:var(--V);background:rgba(16,185,129,0.05)}
.opt.ko{border-color:var(--R);background:rgba(239,68,68,0.05)}
.fb{margin-top:2rem;padding:1.5rem;border-radius:16px;animation:slideUp .3s ease forwards}
.fb.ok{background:#ecfdf5;border:1px solid var(--V);color:#065f46}
.fb.ko{background:#fef2f2;border:1px solid var(--R);color:#991b1b}
.nav{display:flex;justify-content:space-between;margin-top:1.5rem}
button.nav-btn{padding:1rem 1.8rem;border-radius:14px;border:none;font-weight:700;cursor:pointer;font-family:'Montserrat'}
.btn-p{background:var(--B);color:var(--D)}
.btn-n{background:var(--D);color:#fff}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<div class="wrap">
  <header><h1>ENFOCADOS</h1></header>

  <div id="loginSection" class="card">
    <h2 style="font-family:'Montserrat';margin-bottom:1rem">Acceso</h2>
    <input type="text" id="dniInput" placeholder="Introduce tu DNI">
    <button class="btn-login" onclick="checkLogin()">ENTRAR</button>
    <p id="loginMsg" style="color:var(--R);margin-top:1rem;display:none">DNI no autorizado</p>
  </div>

  <div id="game" style="display:none">
    <div class="card">
      <div class="p-wrap">
        <div class="p-top"><span id="qNum"></span><span id="qProg"></span></div>
        <div class="p-bar-bg"><div id="pbar"></div></div>
      </div>
      <div id="qArea"></div>
      <div id="fbWrap"></div>
      <div class="nav">
        <button onclick="prevQ()" id="prevBtn" class="nav-btn btn-p">Anterior</button>
        <button onclick="nextQ()" id="nextBtn" class="nav-btn btn-n">Siguiente</button>
      </div>
    </div>
  </div>

  <div id="results" class="card" style="display:none; text-align:center">
    <div id="rEmoji" style="font-size:4.5rem;margin-bottom:1rem">üèÜ</div>
    <h2 style="font-family:'Montserrat'">¬°Test Finalizado!</h2>
    <div style="font-size:3.5rem;font-weight:800;margin:1rem 0" id="rPct">0%</div>
    <p>Correctas: <span id="rOk">0</span> | Incorrectas: <span id="rKo">0</span> de <span id="rTot">0</span></p>
    <button onclick="location.reload()" class="nav-btn btn-n" style="margin-top:2rem">Reiniciar</button>
  </div>
</div>

<script>
// URLs de tus Google Sheets
const URL_USUARIOS = 'https://docs.google.com/spreadsheets/d/1niLz8cxdTrNBJMAU0YDMRpiAWEmbGHt7h4HEPD6xkLA/export?format=csv&gid=353115110';
const URL_PREGUNTAS = 'https://docs.google.com/spreadsheets/d/19mVUe0lezjxuAW4FqJTbG5UJx649ECUzA9HVwEwy0do/export?format=csv&gid=1012787791';

let users = [], exam = [], correct = [], idx = 0;

// Cargar lista de usuarios al inicio
fetch(URL_USUARIOS).then(r => r.text()).then(csv => { users = parseCSV(csv); });

function parseCSV(csv) {
  const lines = csv.split('\n');
  const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
  return lines.slice(1).filter(l => l.trim()).map(line => {
    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    const obj = {};
    headers.forEach((h, i) => {
      let v = values[i] ? values[i].trim().replace(/^"|"$/g, '') : "";
      obj[h] = v;
    });
    return obj;
  });
}

function checkLogin() {
  const dni = document.getElementById('dniInput').value.trim().toUpperCase();
  const found = users.find(u => (u.dni || u.DNI) === dni);
  if (found) {
    document.getElementById('loginSection').style.display = 'none';
    loadExam();
  } else {
    document.getElementById('loginMsg').style.display = 'block';
  }
}

function loadExam() {
  fetch(URL_PREGUNTAS).then(r => r.text()).then(csv => {
    exam = parseCSV(csv);
    document.getElementById('game').style.display = 'block';
    showQ();
  });
}

function showQ() {
  const q = exam[idx];
  const area = document.getElementById('qArea');
  const fbWrap = document.getElementById('fbWrap');
  fbWrap.innerHTML = '';
  
  document.getElementById('qNum').textContent = 'Pregunta ' + (idx + 1);
  document.getElementById('qProg').textContent = (idx + 1) + ' de ' + exam.length;
  document.getElementById('pbar').style.width = ((idx + 1) / exam.length * 100) + '%';
  document.getElementById('prevBtn').disabled = (idx === 0);

  // Renderizar pregunta y din√°micamente sus opciones (sin l√≠mite de 4)
  let html = `<div class="qtxt">${q.pregunta}</div><div class="opts">`;
  
  // Extraemos todas las columnas que empiecen por "opcion_"
  const opcionesKeys = Object.keys(q).filter(k => k.startsWith('opcion_') && q[k]);
  
  opcionesKeys.forEach(key => {
    const letra = key.split('_')[1].toUpperCase();
    const texto = q[key];
    let cls = 'opt';
    
    if (correct[idx] !== undefined) {
      if (letra.toLowerCase() === q.respuesta.toLowerCase()) cls += ' ok';
      else if (correct[idx] === letra.toLowerCase()) cls += ' ko';
    }

    html += `<div class="${cls}" onclick="selectOpt('${letra.toLowerCase()}')">
               <div style="width:36px;height:36px;background:var(--Y);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;margin-right:1.2rem;flex-shrink:0">${letra}</div>
               <span>${texto}</span>
             </div>`;
  });
  
  html += `</div>`;
  area.innerHTML = html;

  if (correct[idx] !== undefined) showFeedback();
}

function selectOpt(letra) {
  if (correct[idx] !== undefined) return;
  correct[idx] = letra;
  showQ();
}

function showFeedback() {
  const q = exam[idx];
  const esCorrecta = (correct[idx] === q.respuesta.toLowerCase());
  const fb = document.createElement('div');
  fb.className = 'fb ' + (esCorrecta ? 'ok' : 'ko');
  fb.innerHTML = `
    <div style="font-weight:800;margin-bottom:0.5rem">${esCorrecta ? '‚úì ¬°Correcto!' : '‚úó Incorrecto'}</div>
    <div><strong>Respuesta correcta:</strong> ${q.respuesta.toUpperCase()}<br><br>
    <strong>Motivaci√≥n:</strong> ${q.saber || 'No disponible'}</div>
  `;
  document.getElementById('fbWrap').appendChild(fb);
}

function nextQ() {
  if (idx < exam.length - 1) { idx++; showQ(); } 
  else { showResults(); }
}

function prevQ() { if (idx > 0) { idx--; showQ(); } }

function showResults() {
  document.getElementById('game').style.display = 'none';
  document.getElementById('results').style.display = 'block';
  let ok = 0;
  exam.forEach((q