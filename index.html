<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENFOCADOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--Y:rgb(250,250,0);--D:#2c3e50;--V:#10b981;--R:#ef4444;--B:#e2e8f0}
        body{font-family:'Inter',sans-serif;background:#fffef0;color:#1e293b;padding:1rem}
        .card{background:#fff;border-radius:15px;padding:1.5rem;box-shadow:0 4px 15px rgba(0,0,0,0.05);border:2px solid var(--Y);max-width:600px;margin:auto}
        h1{font-family:'Montserrat';text-align:center;margin-bottom:1rem;color:var(--D)}
        .field{margin-bottom:1rem}
        input, select{width:100%;padding:12px;border:2px solid var(--B);border-radius:8px;font-size:16px}
        .btn{width:100%;padding:15px;background:var(--Y);color:var(--D);border:none;border-radius:8px;font-weight:700;cursor:pointer;font-family:'Montserrat'}
        .btn:disabled{background:#ccc;cursor:not-allowed}
        .opt{padding:12px;border:2px solid var(--B);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:0.2s;display:flex;align-items:center}
        .opt.ok{border-color:var(--V);background:#f0fdf4}
        .opt.ko{border-color:var(--R);background:#fef2f2}
        .opt.dis{pointer-events:none}
        .fb{margin-top:1rem;padding:1rem;border-radius:8px;font-size:0.9rem;line-height:1.4}
        .fb.ok{background:#f0fdf4;color:#065f46;border:1px solid var(--V)}
        .fb.ko{background:#fef2f2;color:#991b1b;border:1px solid var(--R)}
        .hidden{display:none}
    </style>
</head>
<body>

<div id="secLogin" class="card">
    <h1>ENFOCADOS</h1>
    <div class="field"><input type="email" id="inEmail" placeholder="Tu correo electrónico"></div>
    <button class="btn" onclick="doLogin()">ENTRAR</button>
</div>

<div id="secLoading" class="card hidden" style="text-align:center">Cargando datos...</div>

<div id="secConfig" class="card hidden">
    <h2 id="cfgUser" style="margin-bottom:1rem; font-size:1rem"></h2>
    <div class="field"><label>Preguntas:</label><input type="number" id="inNum" value="10"></div>
    <div class="field"><label>Materia:</label><select id="selMateria"></select></div>
    <button class="btn" onclick="startExam()">EMPEZAR TEST</button>
</div>

<div id="secQ" class="card hidden">
    <div id="qProg" style="font-size:0.8rem;color:gray;margin-bottom:0.5rem"></div>
    <div id="qTxt" style="font-weight:600;margin-bottom:1.5rem;font-size:1.1rem"></div>
    <div id="optsWrap"></div>
    <div id="fbWrap"></div>
    <button id="btnNext" class="btn hidden" style="margin-top:1rem" onclick="nextQ()">CONTINUAR</button>
</div>

<div id="secRes" class="card hidden" style="text-align:center">
    <h1>RESULTADO</h1>
    <div id="rPct" style="font-size:3rem;font-weight:800"></div>
    <p style="margin-bottom:1.5rem">Aciertos: <span id="rOk"></span> | Errores: <span id="rKo"></span></p>
    <button class="btn" onclick="location.reload()">VOLVER A EMPEZAR</button>
</div>

<script>
const apiUrl = 'https://script.google.com/macros/s/AKfycbxOW1CWs8n04Lek1Sm0mYZE_F6N0epkbvr0czCt_QzY7qdn65X3g1oya0Br2BtwXQBS/exec';
let allQ = [], exam = [], idx = 0, correctCount = 0;

function fetchJSONP(url, cb) {
    const name = 'jsonp_' + Date.now();
    window[name] = (data) => { delete window[name]; document.body.removeChild(s); cb(data); };
    const s = document.createElement('script');
    s.src = url + (url.indexOf('?')>=0?'&':'?') + 'callback=' + name;
    document.body.appendChild(s);
}

function parse(res) {
    return res.rows.map(row => {
        let o = {};
        res.headers.forEach((h, i) => o[h.toLowerCase().trim()] = row[i]);
        return o;
    });
}

function doLogin() {
    const email = document.getElementById('inEmail').value.trim().toLowerCase();
    if(!email) return;
    document.getElementById('secLogin').classList.add('hidden');
    document.getElementById('secLoading').classList.remove('hidden');

    fetchJSONP(apiUrl + '?type=users&t=' + Date.now(), (res) => {
        const users = parse(res);
        const user = users.find(u => u.correo && u.correo.toLowerCase().trim() === email);
        if(user) {
            fetchJSONP(apiUrl + '?type=questions&t=' + Date.now(), (qRes) => {
                allQ = parse(qRes);
                const mats = [...new Set(allQ.map(q => q.materia))];
                const sel = document.getElementById('selMateria');
                sel.innerHTML = '<option value="">Todas</option>';
                mats.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
                document.getElementById('cfgUser').innerText = "Hola, " + (user.usuario || email);
                document.getElementById('secLoading').classList.add('hidden');
                document.getElementById('secConfig').classList.remove('hidden');
            });
        } else {
            alert("Acceso no autorizado");
            location.reload();
        }
    });
}

function startExam() {
    const mat = document.getElementById('selMateria').value;
    const num = parseInt(document.getElementById('inNum').value);
    let pool = mat ? allQ.filter(q => q.materia === mat) : allQ;
    exam = pool.sort(() => 0.5 - Math.random()).slice(0, num);
    idx = 0; correctCount = 0;
    showQ();
    document.getElementById('secConfig').classList.add('hidden');
    document.getElementById('secQ').classList.remove('hidden');
}

function showQ() {
    const q = exam[idx];
    document.getElementById('qProg').innerText = `PREGUNTA ${idx + 1} DE ${exam.length}`;
    document.getElementById('qTxt').innerText = q.pregunta;
    document.getElementById('fbWrap').innerHTML = "";
    document.getElementById('btnNext').classList.add('hidden');
    
    // RESOLUCIÓN CLAUDE: Split por salto de línea
    const opts = (q.opciones || '').split('\n').filter(o => o.trim());
    const wrap = document.getElementById('optsWrap');
    wrap.innerHTML = "";

    opts.forEach((text) => {
        const div = document.createElement('div');
        div.className = 'opt';
        // Limpiamos la letra o número al inicio para que el botón se vea limpio
        div.innerText = text.replace(/^[a-dA-D0-4][\.\)\-\s]+/, '').trim();
        
        div.onclick = () => {
            const allOpts = wrap.querySelectorAll('.opt');
            allOpts.forEach(o => o.classList.add('dis'));
            
            const letraPulsada = text.trim().substring(0, 1).toUpperCase();
            const correcta = q.respuesta.toString().trim().toUpperCase();
            
            if(letraPulsada === correcta) {
                div.classList.add('ok');
                correctCount++;
                showFeedback(true, q.saber, correcta);
            } else {
                div.classList.add('ko');
                showFeedback(false, q.saber, correcta);
            }
            document.getElementById('btnNext').classList.remove('hidden');
        };
        wrap.appendChild(div);
    });
}

function showFeedback(isOk, saber, correcta) {
    const fb = document.getElementById('fbWrap');
    fb.innerHTML = `
        <div class="fb ${isOk ? 'ok' : 'ko'}">
            <strong>${isOk ? '✓ ¡CORRECTO!' : '✗ INCORRECTO'}</strong><br>
            <p style="margin-top:5px">Respuesta correcta: ${correcta}</p>
            <p style="margin-top:10px; font-style:italic">${saber || ""}</p>
        </div>`;
}

function nextQ() {
    idx++;
    if(idx < exam.length) showQ();
    else {
        document.getElementById('secQ').classList.add('hidden');
        document.getElementById('secRes').classList.remove('hidden');
        document.getElementById('rPct').innerText = Math.round((correctCount/exam.length)*100) + "%";
        document.getElementById('rOk').innerText = correctCount;
        document.getElementById('rKo').innerText = exam.length - correctCount;
    }
}
</script>
</body>
</html>
